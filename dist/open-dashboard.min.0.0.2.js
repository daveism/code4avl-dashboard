/**
 * Open Dashboard - v0.0.2 - 6/15/2013
 * https://github.com/fastfedora/code4avl-dashboard/
 * Copyright (c) 2013 Trevor Lohrbeer (Fast Fedora);
 * License: MIT
 * https://github.com/fastfedora/code4avl-dashboard/blob/master/LICENSE
 */
!function(a,b){var c=a.Code4AVL||(a.Code4AVL={});c.Dashboard=function(a){return b.extend(this,a),this.containerSelector="body",this.spreadsheetKey=a.key,this.widgetWorksheet="1",this.dataWorksheet="2",this.widgets={},this},b.extend(c.Dashboard.prototype,{show:function(){this.loadWidgets()},loadWidgets:function(){var a=this,b=new Miso.Dataset({key:this.spreadsheetKey,worksheet:this.widgetWorksheet,importer:Miso.Dataset.Importers.GoogleSpreadsheet,parser:Miso.Dataset.Parsers.GoogleSpreadsheet});b.fetch({success:function(){var b=function(b){var d=a.widgets[b.Widget];null==d&&(d=new c.Dashboard.Widget({name:b.Widget}),a.widgets[b.Widget]=d),null==d.options&&(d.options={}),d.options[b.Parameter]=b.Value};this.each(b),a.loadData()},error:function(){}})},loadData:function(){var a=this,b=new Miso.Dataset({key:this.spreadsheetKey,worksheet:this.dataWorksheet,importer:Miso.Dataset.Importers.GoogleSpreadsheet,parser:Miso.Dataset.Parsers.GoogleSpreadsheet});b.fetch({success:function(){var b=function(b){var c=a.widgets[b.Metric];null==c?console.log("Warning: Could not find widget named '"+b.Metric+"'."):c.addData(b)};this.each(b),a.build()},error:function(){}})},build:function(){var a=this.getContainer(),b=this.widgets;for(var c in b){var d=b[c];d.build(a)}},getContainer:function(){return d3.select(this.containerSelector)}})}(this,_),function(a,b){var c=a.Code4AVL||(a.Code4AVL={}),d=a.Code4AVL.Dashboard;d.Widget=function(a){return b.extend(this,a),this},b.extend(d.Widget.prototype,{addData:function(a){null==this.data&&(this.data=[]),this.data.push(a)},build:function(a){var b=this.options,c=a.append("div").attr("class","widget");this.addText(c,b.title,"h2","title"),this.addChart(c),this.addText(c,b.description,"h3","description")},addText:function(a,b,c,d,e){if(null!=b){var f=a.append(c);null!=d&&f.attr("class",d),null!=e&&f.attr("id",e),f.text(b)}},addChart:function(a){var b=this.options["control.type"],d=null;"stoplight"==b?d=new c.Dashboard.Chart.Stoplight({parent:a,data:this.data,options:this.options}):"pie"==b&&(d=new c.Dashboard.Chart.Pie({parent:a,data:this.data,options:this.options})),null!=d&&d.draw()}})}(this,_),function(a,b){a.Code4AVL||(a.Code4AVL={});var c=a.Code4AVL.Dashboard;c.WidgetGroup=function(a){return b.extend(this,a),this.widgets=widgets||{},this}}(this,_),function(a){a.Code4AVL||(a.Code4AVL={});var b=a.Code4AVL.Dashboard,c=b.Chart||(b.Chart={});c.Util={},c.Util.getLength=function(a,b){var c=a.style(b);return null!=c&&c.lastIndexOf("px")==c.length-2&&(c=c.substring(0,c.length-2)),null!=c?+c:null}}(this,_),function(a,b){a.Code4AVL||(a.Code4AVL={});var c=a.Code4AVL.Dashboard,d=c.Chart||(c.Chart={});d.ColorScheme=function(a){return b.extend(this,a),this.style="discrete",this.values=[],this.colors=[],this._initialize(a),this},b.extend(d.ColorScheme.prototype,{_initialize:function(a){var b=1;if(null!=a["colors.type"]&&(this.style=a["colors.type"]),"discrete"==this.style)for(;null!=a["colors["+b+"].color"];)this.parseColorPoint(a,b++);else if("category"==this.style)for(;null!=a["colors["+b+"].color"];)this.colors[b-1]=a["colors["+b+"].color"],b++},parseColorPoint:function(a,b){var c=a["colors["+b+"].value"],d=a["colors["+b+"].color"];this.values[b-1]=null!=c?+c:null,this.colors[b-1]=d},getColor:function(a){for(var b=null!=a?+a:null,c=this.colors[0],d=0;d<this.values.length&&null!=this.values[d]&&b>=this.values[d];d++)c=this.colors[d];return null!=c?c:"invalid value "+a}})}(this,_),function(a,b){a.Code4AVL||(a.Code4AVL={});var c=a.Code4AVL.Dashboard,d=c.Chart||(c.Chart={});d.Stoplight=function(a){return b.extend(this,a),this.width=200,this.height=200,this.radius=60,this.colorScheme=new d.ColorScheme(a.options),this},b.extend(d.Stoplight.prototype,{draw:function(){var a=this.parent.append("svg").attr("class","stoplightChart"),b=a.append("g"),c=d.Util.getLength(a,"width"),e=d.Util.getLength(a,"height"),f=100;b.append("rect").attr("width",this.radius).attr("height",+this.data[0].Value/10*f).attr("x",(c-this.radius)/2).attr("y",100).attr("fill",this.getColor()).append("title").text(this.data[0].Value),b.append("text").attr("class","value").attr("x",c/2).attr("y",e/2).attr("dy",".4em").attr("text-anchor","middle").text(this.data.Value)},getColor:function(){return this.colorScheme.getColor(this.data[0].Value)}})}(this,_),function(a,b){a.Code4AVL||(a.Code4AVL={});var c=a.Code4AVL.Dashboard,d=c.Chart||(c.Chart={});d.Pie=function(a){return b.extend(this,a),this.width=200,this.height=200,this.radius=60,this.innerRadius=0,this.colorScheme=new d.ColorScheme(a.options),this},b.extend(d.Pie.prototype,{draw:function(){var a=this.parent.append("svg").attr("class","pieChart"),b=d.Util.getLength(a,"width"),c=d.Util.getLength(a,"height"),e=d3.scale.ordinal().range(this.colorScheme.colors),f=this.prepareData(this.data),g=this.radius+(b-2*this.radius)/2,h=this.radius+(c-2*this.radius)/2,i=a.append("g").data([f]).attr("transform","translate("+g+","+h+")"),j=d3.svg.arc().outerRadius(this.radius),k=d3.layout.pie().value(function(a){return a.value}),l=i.selectAll("g.slice").data(k).enter().append("svg:g").attr("class","slice");l.append("svg:path").attr("fill",function(a,b){return e(b)}).attr("d",j).append("title").text(function(a,b){return f[b].label+" - "+f[b].value}),l.append("svg:text").attr("transform",function(a){return a.innerRadius=0,a.outerRadius=this.radius,"translate("+j.centroid(a)+")"}).attr("text-anchor","middle").text(function(a,b){return f[b].label})},getColor:function(){return this.colorScheme.getColor(this.data.Value)},prepareData:function(a){for(var b=[],c=0;c<a.length;c++)b[c]={label:a[c].Category,value:+a[c].Value};return b}})}(this,_);